AWSTemplateFormatVersion: "2010-09-09"
Description: (SO0163) - aws-media-insights-engine %%VERSION%%. This is the base AWS CloudFormation template that provisions Media Insights Engine services and provides parameters for user configurable MIE settings.

Parameters:
  DeployTestResources:
    Description: Deploy test resources which contains lambdas required for integration and e2e testing
    Type: String
    Default: No
    AllowedValues:
      - Yes
      - No
  DeployAnalyticsPipeline:
    Type: String
    Description: Deploy a metadata streaming pipeline that can be consumed by downstream analytics plaforms
    Default: Yes
    AllowedValues:
      - Yes
      - No
  MaxConcurrentWorkflows:
    Type: Number
    Description: Maximum number of workflows to run concurrently.  When the maximum is reached, additional workflows are added to a wait queue.
    Default: 5
    MinValue: 1
  EnableXrayTrace:
    Description: Turn on Xray tracing on all entry points to the stack
    Type: String
    Default: Yes
    AllowedValues:
      - Yes
      - No
  ExternalBucketArn:
    Description: (Optional) If you intend to input media files from a bucket outside the MIE stack into MIE workflows, then specify the Amazon S3 ARN for those files here.
    Type: String
    Default: ""
  SolutionId:
    Description: (Optional) AWS Solution Id used for reporting purposes
    Type: String
    Default: SO0163
  SolutionVersion:
    Description: (Optional) AWS Solution version used for reporting purposes
    Type: String
    Default: %%VERSION%%
  SendAnonymousData:
    Description: (Optional) Send anonymous data about MIE performance to AWS to help improve the quality of this solution.
    Type: String
    Default: No
    AllowedValues:
      - Yes
      - No

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      #     -
      #       Label:
      #           default: Control Plane Configuration
      #       Parameters:
      #     -
      #       Label:
      #           default: Data Plane Configuration
      #       Parameters:
      - Label:
          default: System Configuration
        Parameters:
          - MaxConcurrentWorkflows

Conditions:
  DeployTestResourcesCondition: !Equals [!Ref DeployTestResources, Yes]
  DeployAnalyticsPipelineCondition: !Equals [!Ref DeployAnalyticsPipeline, Yes]
  EnableTraceOnEntryPoints: !Equals [!Ref EnableXrayTrace, Yes]
  EnableAnonymousData: !Equals [ !Ref SendAnonymousData, Yes]

Mappings:
  SourceCode:
    General:
      GlobalS3Bucket: "%%GLOBAL_BUCKET_NAME%%"
      RegionalS3Bucket: "%%REGIONAL_BUCKET_NAME%%"
      CodeKeyPrefix: "aws-media-insights-engine/%%VERSION%%"
      TemplateKeyPrefix: "aws-media-insights-engine/%%VERSION%%"
      FrameworkVersion: "%%VERSION%%"

Resources:
  # Helper function - create a short UUID to avoid name conflicts
  MieHelperFunction:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      Environment:
        Variables:
          SYSTEM_TABLE_NAME: !Ref SystemTable
          DEFAULT_MAX_CONCURRENT_WORKFLOWS: !Ref MaxConcurrentWorkflows
      Code:
        ZipFile: |
          import string
          import cfnresponse
          import random
          import boto3
          import os
          def id_generator(size=6, chars=string.ascii_lowercase + string.digits):
            return "".join(random.choices(chars, k=size))
          def get_mediaconvert_endpoint():
            mediaconvert_client = boto3.client("mediaconvert", region_name=os.environ['AWS_REGION'])
            response = mediaconvert_client.describe_endpoints()
            mediaconvert_endpoint = response["Endpoints"][0]["Url"]
            response_data = {'Data': mediaconvert_endpoint}
            return response_data
          def init_system_table():
            dynamodb_client = boto3.resource("dynamodb")
            SYSTEM_TABLE_NAME = os.environ["SYSTEM_TABLE_NAME"]
            DEFAULT_MAX_CONCURRENT_WORKFLOWS = int(os.environ["DEFAULT_MAX_CONCURRENT_WORKFLOWS"])
            system_table = dynamodb_client.Table(SYSTEM_TABLE_NAME)
            config={"Name":"MaxConcurrentWorkflows", "Value":DEFAULT_MAX_CONCURRENT_WORKFLOWS}
            return system_table.put_item(Item=config)
          def handler(event, context):
            print("We got the following event:\n", event)
            if event['ResourceProperties']['FunctionKey'] == 'get_short_uuid':
              response_data = {'Data': id_generator()}
              cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data, "CustomResourcePhysicalID")
            elif event['ResourceProperties']['FunctionKey'] == 'init_system_table':
              response_data = init_system_table()
              cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data, "CustomResourcePhysicalID")
            elif event['ResourceProperties']['FunctionKey'] == 'get_mediaconvert_endpoint':
                response_data = get_mediaconvert_endpoint()
                cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data, "CustomResourcePhysicalID")
      Handler: index.handler
      Runtime: python3.8
      Role: !GetAtt MieHelperExecutionRole.Arn
      Tags:
        - Key: "environment"
          Value: "mie"

  MieHelperFunctionPermissions:
    Type: AWS::Lambda::Permission
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !GetAtt MieHelperFunction.Arn
      Principal: 'cloudformation.amazonaws.com'

  GetShortUUID:
    Type: Custom::CustomResource
    Properties:
      ServiceToken: !GetAtt MieHelperFunction.Arn
      FunctionKey: "get_short_uuid"

  InitSystemTable:
    Type: Custom::CustomResource
    DependsOn:
      - MediaInsightsDataplaneApiStack
    Properties:
      ServiceToken: !GetAtt MieHelperFunction.Arn
      FunctionKey: "init_system_table"

  GetMediaConvertEndpoint:
    Type: Custom::CustomResource
    Properties:
      ServiceToken: !GetAtt MieHelperFunction.Arn
      FunctionKey: "get_mediaconvert_endpoint"


  # IAM Roles
  MieHelperExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Join [
                    "",
                    [
                      "arn:aws:logs:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":log-group:/aws/lambda/*",
                    ],
                  ]
              - Effect: Allow
                Action: ['dynamodb:PutItem']
                Resource:
                  - !Join [
                    "",
                    [
                      "arn:aws:dynamodb:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":table/",
                      Ref: "SystemTable",
                    ]
                  ]
              - Effect: Allow
                Action: 'mediaconvert:DescribeEndpoints'
                Resource:
                  - !Join [
                    "",
                    [
                      "arn:aws:mediaconvert:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":endpoints/*"
                    ]
                  ]
      Tags:
        - Key: "environment"
          Value: "mie"

  StageExecutionRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The X-Ray policy applies to all resources - can't be scoped to a specific resource"
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Tags:
        - Key: "environment"
          Value: "mie"
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-stage-execution-lambda"
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                Resource:
                  - !Join [
                    "",
                    [
                      "arn:aws:states:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":stateMachine:",
                      "*",
                    ],
                  ]
                Condition:
                  StringEquals:
                    aws:ResourceTag/environment: "mie"
              - Effect: Allow
                Action:
                  - "dynamodb:GetItem"
                  - "dynamodb:Query"
                  - "dynamodb:Scan"
                  - "dynamodb:DescribeTable"
                  - "dynamodb:BatchGetItem"
                  - "dynamodb:GetRecords"
                  - "dynamodb:DescribeLimits"
                  - "dynamodb:PutItem"
                  - "dynamodb:UpdateItem"
                  - "dynamodb:DeleteItem"
                  - "dynamodb:BatchWriteItem"
                Resource:
                  - !Join [
                      "",
                      [
                        "arn:aws:dynamodb:",
                        Ref: "AWS::Region",
                        ":",
                        Ref: "AWS::AccountId",
                        ":table/",
                        Ref: "WorkflowTable",
                      ],
                    ]
                  - !Join [
                    "",
                    [
                      "arn:aws:dynamodb:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":table/",
                      Ref: "WorkflowExecutionTable",
                    ],
                  ]
                  - !Join [
                      "",
                      [
                        "arn:aws:dynamodb:",
                        Ref: "AWS::Region",
                        ":",
                        Ref: "AWS::AccountId",
                        ":table/",
                        Ref: "WorkflowExecutionTable",
                        "/index/",
                        "*",
                      ],
                    ]
                  - !Join [
                    "",
                    [
                      "arn:aws:dynamodb:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":table/",
                      Ref: "SystemTable",
                    ],
                  ]
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Join [
                    "",
                    [
                      "arn:aws:logs:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":log-group:/aws/lambda/*",
                    ],
                  ]
              - Effect: Allow
                Action:
                  - sqs:DeleteMessage
                  - sqs:ListQueues
                  - sqs:ChangeMessageVisibility
                  - sqs:ReceiveMessage
                  - sqs:SendMessage
                Resource:
                  - "Fn::GetAtt":
                      - StageExecutionQueue
                      - Arn
                  - "Fn::GetAtt":
                      - WorkflowExecutionLambdaDeadLetterQueue
                      - Arn
              - Effect: Allow
                Action:
                  - "xray:PutTraceSegments"
                  - "xray:PutTelemetryRecords"
                Resource: "*"

  OperationLambdaExecutionRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The X-Ray policy applies to all resources - can't be scoped to a specific resource"
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Tags:
        - Key: "environment"
          Value: "mie"
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-operation-lambda"
          PolicyDocument:
            Statement:
              - Effect: "Allow"
                Action:
                  - "states:DescribeExecution"
                  - "states:GetExecutionHistory"
                  - "states:StopExecution"
                Resource:
                  - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:execution:*:*"
              - Effect: Allow
                Action:
                  - states:StartExecution
                Resource:
                  - !Join [
                    "",
                    [
                      "arn:aws:states:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":stateMachine:",
                      "*",
                    ],
                  ]
                Condition:
                  StringEquals:
                    aws:ResourceTag/environment: "mie"
              - Effect: Allow
                Action:
                  - "dynamodb:GetItem"
                  - "dynamodb:Query"
                  - "dynamodb:Scan"
                  - "dynamodb:DescribeTable"
                  - "dynamodb:BatchGetItem"
                  - "dynamodb:GetRecords"
                  - "dynamodb:DescribeLimits"
                  - "dynamodb:PutItem"
                  - "dynamodb:UpdateItem"
                  - "dynamodb:DeleteItem"
                  - "dynamodb:BatchWriteItem"
                Resource:
                  - !Join [
                      "",
                      [
                        "arn:aws:dynamodb:",
                        Ref: "AWS::Region",
                        ":",
                        Ref: "AWS::AccountId",
                        ":table/",
                        Ref: "WorkflowTable",
                      ],
                    ]
                  - !Join [
                    "",
                    [
                      "arn:aws:dynamodb:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":table/",
                      Ref: "WorkflowExecutionTable",
                    ],
                  ]
                  - !Join [
                      "",
                      [
                        "arn:aws:dynamodb:",
                        Ref: "AWS::Region",
                        ":",
                        Ref: "AWS::AccountId",
                        ":table/",
                        Ref: "WorkflowExecutionTable",
                        "/index/",
                        "*",
                      ],
                    ]
                  - !Join [
                    "",
                    [
                      "arn:aws:dynamodb:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":table/",
                      Ref: "SystemTable",
                    ],
                  ]
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Join [
                    "",
                    [
                      "arn:aws:logs:",
                      Ref: "AWS::Region",
                      ":",
                      Ref: "AWS::AccountId",
                      ":log-group:/aws/lambda/*",
                    ],
                  ]
              - Effect: Allow
                Action:
                  - sqs:DeleteMessage
                  - sqs:ListQueues
                  - sqs:ChangeMessageVisibility
                  - sqs:ReceiveMessage
                  - sqs:SendMessage
                Resource:
                  - "Fn::GetAtt":
                      - StageExecutionQueue
                      - Arn
                  - "Fn::GetAtt":
                      - WorkflowExecutionLambdaDeadLetterQueue
                      - Arn
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - "Fn::GetAtt":
                      - WorkflowSchedulerLambda
                      - Arn
              - Effect: Allow
                Action:
                  - "xray:PutTraceSegments"
                  - "xray:PutTelemetryRecords"
                Resource: "*"

  StepFunctionRole:
    Type: "AWS::IAM::Role"
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The X-Ray policy applies to all resources - can't be scoped to a specific resource"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: "sts:AssumeRole"
            Effect: "Allow"
            Principal:
              Service: "states.amazonaws.com"
      Tags:
        - Key: "environment"
          Value: "mie"
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-sfn-lambda-exec"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action: "lambda:InvokeFunction"
                Resource:
                  - "arn:aws:lambda:*:*:function:*OperatorLibrary*"
                  - "arn:aws:lambda:*:*:function:*start-wait-operation"
                  - "arn:aws:lambda:*:*:function:*check-wait-operation"
                  - "arn:aws:lambda:*:*:function:*CompleteStageLambda*"
                  - "arn:aws:lambda:*:*:function:*OperatorFailedLambda*"
                  - "arn:aws:lambda:*:*:function:*FilterOperationLambda*"
                Effect: "Allow"
              - Effect: "Allow"
                Action:
                  - "xray:PutTraceSegments"
                  - "xray:PutTelemetryRecords"
                  - "xray:GetSamplingRules"
                  - "xray:GetSamplingTargets"
                Resource: "*"

  operatorFailedRole:
    Type: "AWS::IAM::Role"
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The X-Ray policy applies to all resources - can't be scoped to a specific resource"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: "sts:AssumeRole"
            Effect: "Allow"
            Principal:
              Service: "lambda.amazonaws.com"
      Tags:
        - Key: "environment"
          Value: "mie"
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-operator-failed"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: "arn:aws:logs:*:*:*:*"
                Effect: Allow
              - Effect: Allow
                Action:
                  - "xray:PutTraceSegments"
                  - "xray:PutTelemetryRecords"
                Resource: "*"


  WorkflowExecutionStreamLambdaRole:
    Type: "AWS::IAM::Role"
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "Lambda requires ability to write to cloudwatch *, as configured in the default AWS lambda execution role."
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-WorkflowExecutionLambdaStreamAccessPolicy"
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - "dynamodb:DescribeStream"
                  - "dynamodb:GetRecords"
                  - "dynamodb:GetShardIterator"
                  - "dynamodb:ListStreams"
                Resource:
                  Fn::GetAtt:
                    - WorkflowExecutionTable
                    - StreamArn
              - Effect: Allow
                Action:
                  - "sns:Publish"
                Resource:
                  !Ref WorkflowExecutionEventTopic
              - Effect: Allow
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  - !Join [
                      "",
                    [
                        "arn:aws:logs:",
                        Ref: "AWS::Region",
                        ":",
                        Ref: "AWS::AccountId",
                        ":log-group:/aws/lambda/*",
                    ],
                  ]

  # Services - Dynamodb

  SystemTable:
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W28
            reason: "Table name is constructed with stack name. On update, we need to keep the existing table name."
    Properties:
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Name
          AttributeType: S
      KeySchema:
        - AttributeName: Name
          KeyType: HASH
      TableName: !Join ["", [Ref: "AWS::StackName", "System"]]
      Tags:
        - Key: "environment"
          Value: "mie"

  WorkflowTable:
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W28
            reason: "Table name is constructed with stack name. On update, we need to keep the existing table name."
    Properties:
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Name
          AttributeType: S
      KeySchema:
        - AttributeName: Name
          KeyType: HASH
      TableName: !Join ["", [Ref: "AWS::StackName", "Workflow"]]
      Tags:
        - Key: "environment"
          Value: "mie"

  StageTable:
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W28
            reason: "Table name is constructed with stack name. On update, we need to keep the existing table name."
    Properties:
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Name
          AttributeType: S
      KeySchema:
        - AttributeName: Name
          KeyType: HASH
      TableName: !Join ["", [Ref: "AWS::StackName", "Stage"]]
      Tags:
        - Key: "environment"
          Value: "mie"

  OperationTable:
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W28
            reason: "Table name is constructed with stack name. On update, we need to keep the existing table name."
    Properties:
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Name
          AttributeType: S
      KeySchema:
        - AttributeName: Name
          KeyType: HASH
      TableName: !Join ["", [Ref: "AWS::StackName", "Operation"]]
      Tags:
        - Key: "environment"
          Value: "mie"

  HistoryTable:
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W28
            reason: "Table name is constructed with stack name. On update, we need to keep the existing table name."
    Properties:
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Id
          AttributeType: S
        - AttributeName: Version
          AttributeType: S
      KeySchema:
        - AttributeName: Id
          KeyType: HASH
        - AttributeName: Version
          KeyType: RANGE
      TableName: !Join ["", [Ref: "AWS::StackName", "History"]]
      Tags:
        - Key: "environment"
          Value: "mie"

  WorkflowExecutionTable:
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W28
            reason: "Table name is constructed with stack name. On update, we need to keep the existing table name."
    Properties:
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Id
          AttributeType: S
        - AttributeName: Status
          AttributeType: S
        - AttributeName: AssetId
          AttributeType: S
      KeySchema:
        - AttributeName: Id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: WorkflowExecutionStatus
          KeySchema:
            - AttributeName: Status
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: WorkflowExecutionAssetId
          KeySchema:
            - AttributeName: AssetId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TableName: !Join ["", [Ref: "AWS::StackName", "WorkflowExecution"]]
      StreamSpecification:
        StreamViewType: "NEW_AND_OLD_IMAGES"
      Tags:
        - Key: "environment"
          Value: "mie"

  DataplaneTable:
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W28
            reason: "Table name is constructed with stack name. On update, we need to keep the existing table name."
    Properties:
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: AssetId
          AttributeType: S
      KeySchema:
        - AttributeName: AssetId
          KeyType: HASH
      TableName: !Join ["", [Ref: "AWS::StackName", "DataplaneTable"]]
      StreamSpecification:
        StreamViewType: "NEW_AND_OLD_IMAGES"
      Tags:
        - Key: "environment"
          Value: "mie"

  # Services - S3
  DataplaneLogsBucket:
    DeletionPolicy: Retain
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: LogDeliveryWrite
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: "environment"
          Value: "mie"
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W35
            reason: "Used to store access logs for other buckets"
          - id: W51
            reason: "Bucket is private and does not need a bucket policy"

  Dataplane:
    Type: "AWS::S3::Bucket"
    DependsOn: DataplaneLogsBucket
    DeletionPolicy: Retain
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: ["HEAD", "GET", "POST", "DELETE", "PUT"]
            AllowedOrigins: ["*"]
            MaxAge: 3000
            ExposedHeaders:
              - x-amz-server-side-encryption
              - x-amz-request-id
              - x-amz-id-2
              - ETag
            Id: AllowUploadsFromWebApp
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LoggingConfiguration:
        DestinationBucketName: !Ref DataplaneLogsBucket
        LogFilePrefix: "access_logs/"
      LifecycleConfiguration:
        Rules:
          - Id: "Keep access log for 10 days"
            Status: Enabled
            Prefix: "access_logs/"
            ExpirationInDays: 10
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
          - Id: "Keep cloudfront log for 10 days"
            Status: Enabled
            Prefix: "cf_logs/"
            ExpirationInDays: 10
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
      Tags:
        - Key: "environment"
          Value: "mie"

  DataplaneBucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket:
        Ref: "Dataplane"
      PolicyDocument:
        Statement:
          - Effect: Deny
            Principal: "*"
            Action: "*"
            Resource: !Sub "arn:aws:s3:::${Dataplane}/*"
            Condition:
              Bool:
                aws:SecureTransport: false


  # Service -SNS

  WorkflowExecutionEventTopic:
    Type: 'AWS::SNS::Topic'
    Properties:
      KmsMasterKeyId: "alias/aws/sns"

  WorkflowExecutionEventTopicPolicy:
    Type: 'AWS::SNS::TopicPolicy'
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The topic permissions are scoped to the account using the condition"
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            AWS: !Ref 'AWS::AccountId'
          Action:
          - SNS:Subscribe
          - SNS:Receive
          Resource: !Ref WorkflowExecutionEventTopic
          Condition:
            StringEquals:
              AWS:SourceOwner: !Ref 'AWS::AccountId'
      Topics:
        - !Ref WorkflowExecutionEventTopic

  WorkflowExecutionEventQueue:
    Type: AWS::SQS::Queue
    Properties:
      RedrivePolicy:
        deadLetterTargetArn:
          "Fn::GetAtt":
            - WorkflowExecutionLambdaDeadLetterQueue
            - Arn
        maxReceiveCount: 1 # Don't retry if stage times out
      KmsMasterKeyId: "alias/aws/sqs"

  SqsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: "The queue permissions are scoped to the SNS topic using the condition"
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            AWS: !Ref 'AWS::AccountId'
          Action:
          - sqs:SendMessage
          Resource: !GetAtt WorkflowExecutionEventQueue.Arn
          Condition:
            ArnEquals:
              aws:SourceArn: !Ref WorkflowExecutionEventTopic
      Queues:
        - !Ref WorkflowExecutionEventQueue

  WorkflowExecutionEventSnsSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      Endpoint: !GetAtt WorkflowExecutionEventQueue.Arn
      TopicArn: !Ref WorkflowExecutionEventTopic


  # Services - SQS

  WorkflowExecutionLambdaDeadLetterQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      QueueName: !Sub "${AWS::StackName}-WorkflowExecLambdaDLQ"
      MessageRetentionPeriod: 43200 # #Maximum, 12 hours in seconds.
      KmsMasterKeyId: "alias/aws/sqs"
      Tags:
        - Key: "environment"
          Value: "mie"

  StageExecutionDeadLetterQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      QueueName: !Sub "${AWS::StackName}-StageExecDLQ"
      MessageRetentionPeriod: 43200 # #Maximum, 12 hours in seconds.
      KmsMasterKeyId: "alias/aws/sqs"
      Tags:
        - Key: "environment"
          Value: "mie"

  StageExecutionQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-StageExec"
      VisibilityTimeout: 43200 #Maximum, 12 hours in seconds.  Stages are long running
      ReceiveMessageWaitTimeSeconds: 20 #Maximum, long poll on this queue, it has one reader that is single threaded
      RedrivePolicy:
        deadLetterTargetArn:
          "Fn::GetAtt":
            - StageExecutionDeadLetterQueue
            - Arn
        maxReceiveCount: 1 # Don't retry if stage times out
      KmsMasterKeyId: "alias/aws/sqs"
      Tags:
        - Key: "environment"
          Value: "mie"

  # Lambda Layers:

  MediaInsightsEnginePython38Layer:
    Type: "AWS::Lambda::LayerVersion"
    DeletionPolicy: Retain
    Properties:
      CompatibleRuntimes:
        - python3.8
      Content:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "media_insights_engine_lambda_layer_python3.8.zip",
            ],
          ]
      Description: Boto3 and MediaInsightsEngineLambdaHelper packages for Python 3.8
      LayerName: media-insights-engine-python38
      LicenseInfo: Apache-2.0

  MediaInsightsEnginePython37Layer:
    Type: "AWS::Lambda::LayerVersion"
    DeletionPolicy: Retain
    Properties:
      CompatibleRuntimes:
        - python3.7
      Content:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "media_insights_engine_lambda_layer_python3.7.zip",
            ],
          ]
      Description: Boto3 and MediaInsightsEngineLambdaHelper packages for Python 3.7
      LayerName: media-insights-engine-python37
      LicenseInfo: Apache-2.0

  MediaInsightsEnginePython36Layer:
    Type: "AWS::Lambda::LayerVersion"
    DeletionPolicy: Retain
    Properties:
      CompatibleRuntimes:
        - python3.6
      Content:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "media_insights_engine_lambda_layer_python3.6.zip",
            ],
          ]
      Description: Boto3 and MediaInsightsEngineLambdaHelper packages for Python 3.6
      LayerName: media-insights-engine-python36
      LicenseInfo: Apache-2.0

  # Services - Lambda

  LambdaSchedule:
    Type: "AWS::Events::Rule"
    DependsOn: WorkflowSchedulerLambda
    Properties:
      Description: >
        A schedule for the Lambda function..
      ScheduleExpression: rate(1 minute)
      State: ENABLED
      Targets:
        - Arn: !Sub ${WorkflowSchedulerLambda.Arn}
          Id: LambdaSchedule

  LambdaSchedulePermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Sub ${WorkflowSchedulerLambda.Arn}
      Principal: "events.amazonaws.com"
      SourceArn: !Sub ${LambdaSchedule.Arn}

  WorkflowSchedulerLambda:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      Environment:
        Variables:
          STAGE_EXECUTION_QUEUE_URL: !Ref StageExecutionQueue
          STAGE_TABLE_NAME: !Ref StageTable
          OPERATION_TABLE_NAME: !Ref OperationTable
          WORKFLOW_EXECUTION_TABLE_NAME: !Ref WorkflowExecutionTable
          WORKFLOW_TABLE_NAME: !Ref WorkflowTable
          SYSTEM_TABLE_NAME: !Ref SystemTable
          DEFAULT_MAX_CONCURRENT_WORKFLOWS: !Ref MaxConcurrentWorkflows
          botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
      Handler: app.workflow_scheduler_lambda
      TracingConfig:
          Mode: !If [EnableTraceOnEntryPoints, "Active", "PassThrough"]
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "workflow.zip",
            ],
          ]
      Layers:
        - !Ref "MediaInsightsEnginePython38Layer"
      MemorySize: 256
      Role:
        Fn::GetAtt:
          - StageExecutionRole
          - Arn
      Runtime: python3.8
      Timeout: 900
      ReservedConcurrentExecutions: 1
      DeadLetterConfig:
        TargetArn:
          Fn::GetAtt:
            - WorkflowExecutionLambdaDeadLetterQueue
            - Arn
      Tags:
        - Key: "environment"
          Value: "mie"

  # Workflow state machine error handler
  WorkflowErrorHandlerLambda:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      Environment:
        Variables:
          STAGE_EXECUTION_QUEUE_URL: !Ref StageExecutionQueue
          STAGE_TABLE_NAME: !Ref StageTable
          OPERATION_TABLE_NAME: !Ref OperationTable
          WORKFLOW_EXECUTION_TABLE_NAME: !Ref WorkflowExecutionTable
          WORKFLOW_TABLE_NAME: !Ref WorkflowTable
          SYSTEM_TABLE_NAME: !Ref SystemTable
          DEFAULT_MAX_CONCURRENT_WORKFLOWS: !Ref MaxConcurrentWorkflows
          ShortUUID: !GetAtt GetShortUUID.Data
          WORKFLOW_SCHEDULER_LAMBDA_ARN:
            Fn::GetAtt:
              - WorkflowSchedulerLambda
              - Arn
      Handler: app.workflow_error_handler_lambda
      TracingConfig:
          Mode: !If [EnableTraceOnEntryPoints, "Active", "PassThrough"]
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "workflow.zip",
            ],
          ]
      Layers:
        - !Ref "MediaInsightsEnginePython38Layer"
      MemorySize: 256
      Role:
        Fn::GetAtt:
          - OperationLambdaExecutionRole
          - Arn
      Runtime: python3.8
      Timeout: 900
      ReservedConcurrentExecutions: 1
      DeadLetterConfig:
        TargetArn:
          Fn::GetAtt:
            - WorkflowExecutionLambdaDeadLetterQueue
            - Arn
      Tags:
        - Key: "environment"
          Value: "mie"

  StateMachineErrorCloudWatchEvent:
    Type: AWS::Events::Rule
    Properties:
        Name: !Sub "${AWS::StackName}-state-error-handler"
        Description: "state machine error handler"
        EventPattern:
            source:
                - "aws.states"
            detail-type:
                - "Step Functions Execution Status Change"
            detail:
                status:
                    - FAILED
                    - ABORTED
                    - TIMED_OUT
        State: ENABLED
        Targets:
            -
                Id: !Ref WorkflowErrorHandlerLambda
                Arn: !GetAtt WorkflowErrorHandlerLambda.Arn

  PermissionToInvokeLambda:
      Type: AWS::Lambda::Permission
      Properties:
          FunctionName: !Ref WorkflowErrorHandlerLambda
          Action: lambda:InvokeFunction
          Principal: events.amazonaws.com
          SourceArn: !GetAtt StateMachineErrorCloudWatchEvent.Arn

  CompleteStageLambda:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    DependsOn:
      - WorkflowSchedulerLambda
    Properties:
      Environment:
        Variables:
          botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
          STAGE_EXECUTION_QUEUE_URL: !Ref StageExecutionQueue
          STAGE_TABLE_NAME: !Ref StageTable
          OPERATION_TABLE_NAME: !Ref OperationTable
          WORKFLOW_EXECUTION_TABLE_NAME: !Ref WorkflowExecutionTable
          WORKFLOW_TABLE_NAME: !Ref WorkflowTable
          SYSTEM_TABLE_NAME: !Ref SystemTable
          WORKFLOW_SCHEDULER_LAMBDA_ARN:
            Fn::GetAtt:
              - WorkflowSchedulerLambda
              - Arn
      Handler: app.complete_stage_execution_lambda
      TracingConfig:
          Mode: "PassThrough"
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "workflow.zip",
            ],
          ]
      Layers:
        - !Ref "MediaInsightsEnginePython38Layer"
      MemorySize: 256
      Role:
        Fn::GetAtt:
          - OperationLambdaExecutionRole
          - Arn
      Runtime: python3.8
      Timeout: 900
      Tags:
        - Key: "environment"
          Value: "mie"

  FilterOperationLambda:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      Environment:
        Variables:
          botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
          STAGE_EXECUTION_QUEUE_URL: !Ref StageExecutionQueue
          STAGE_TABLE_NAME: !Ref StageTable
          OPERATION_TABLE_NAME: !Ref OperationTable
          WORKFLOW_EXECUTION_TABLE_NAME: !Ref WorkflowExecutionTable
          WORKFLOW_TABLE_NAME: !Ref WorkflowTable
      Handler: app.filter_operation_lambda
      TracingConfig:
          Mode: "PassThrough"
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "workflow.zip",
            ],
          ]
      Layers:
        - !Ref "MediaInsightsEnginePython38Layer"
      MemorySize: 256
      Role:
        Fn::GetAtt:
          - OperationLambdaExecutionRole
          - Arn
      Runtime: python3.8
      Timeout: 900
      Tags:
        - Key: "environment"
          Value: "mie"

  OperatorFailedLambda:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      Handler: "operator_failed.lambda_handler"
      Layers:
        - !Ref "MediaInsightsEnginePython38Layer"
      Role: !GetAtt "operatorFailedRole.Arn"
      TracingConfig:
          Mode: "PassThrough"
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
              !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
              "operator_failed.zip",
            ],
          ]
      Runtime: "python3.8"
      Tags:
        - Key: "environment"
          Value: "mie"

  StartWaitOperationLambda:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      FunctionName: !Sub "${AWS::StackName}-start-wait-operation"
      Environment:
        Variables:
          botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
          STAGE_EXECUTION_QUEUE_URL: !Ref StageExecutionQueue
          STAGE_TABLE_NAME: !Ref StageTable
          OPERATION_TABLE_NAME: !Ref OperationTable
          WORKFLOW_EXECUTION_TABLE_NAME: !Ref WorkflowExecutionTable
          WORKFLOW_TABLE_NAME: !Ref WorkflowTable
      Handler: app.start_wait_operation_lambda
      Layers:
        - !Ref "MediaInsightsEnginePython38Layer"
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "workflow.zip",
            ],
          ]
      MemorySize: 256
      Role:
        Fn::GetAtt:
          - OperationLambdaExecutionRole
          - Arn
      Runtime: python3.8
      Timeout: 900
      Tags:
        - Key: "environment"
          Value: "mie"

  CheckWaitOperationLambda:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      FunctionName: !Sub "${AWS::StackName}-check-wait-operation"
      Environment:
        Variables:
          botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
          STAGE_EXECUTION_QUEUE_URL: !Ref StageExecutionQueue
          STAGE_TABLE_NAME: !Ref StageTable
          OPERATION_TABLE_NAME: !Ref OperationTable
          WORKFLOW_EXECUTION_TABLE_NAME: !Ref WorkflowExecutionTable
          WORKFLOW_TABLE_NAME: !Ref WorkflowTable
      Handler: app.check_wait_operation_lambda
      Layers:
        - !Ref "MediaInsightsEnginePython38Layer"
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "workflow.zip",
            ],
          ]
      MemorySize: 256
      Role:
        Fn::GetAtt:
          - OperationLambdaExecutionRole
          - Arn
      Runtime: python3.8
      Timeout: 900
      Tags:
        - Key: "environment"
          Value: "mie"

  WorkflowExecutionStreamingFunction:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      Handler: "workflowstream.lambda_handler"
      Role: !GetAtt WorkflowExecutionStreamLambdaRole.Arn
      Environment:
        Variables:
          TOPIC_ARN: !Ref WorkflowExecutionEventTopic
          botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key:
          !Join [
            "/",
            [
              !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
              "workflowstream.zip",
            ],
          ]
      Runtime: "python3.8"
      Tags:
        - Key: "environment"
          Value: "mie"

# stream event mapping for lambda

  StreamingFunctionEventMapping:
    Type: "AWS::Lambda::EventSourceMapping"
    Properties:
      Enabled: true
      EventSourceArn:
        Fn::GetAtt:
          - WorkflowExecutionTable
          - StreamArn
      FunctionName: !GetAtt WorkflowExecutionStreamingFunction.Arn
      StartingPosition: "LATEST"

  # DataPlane API Stack
  MediaInsightsDataplaneApiStack:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL:
        !Join [
          "",
          [
            "https://",
            !FindInMap ["SourceCode", "General", "GlobalS3Bucket"],
            ".s3.amazonaws.com/",
            !FindInMap ["SourceCode", "General", "TemplateKeyPrefix"],
            "/media-insights-dataplane-api-stack.template",
          ],
        ]
      Parameters:
        botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
        DataplaneTableName: !Ref DataplaneTable
        ExternalBucketArn: !Ref ExternalBucketArn
        DataplaneBucketName: !Ref Dataplane
        DeploymentPackageBucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        TracingConfigMode: !If [EnableTraceOnEntryPoints, "Active", "PassThrough"]
        DeploymentPackageKey:
          !Join [
            "/",
            [
              !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
              "dataplaneapi.zip",
            ],
          ]
        MediaInsightsEnginePython38Layer: !Ref MediaInsightsEnginePython38Layer
        FrameworkVersion: !FindInMap ["SourceCode", "General", "FrameworkVersion"]

  Analytics:
    Type: "AWS::CloudFormation::Stack"
    Condition: DeployAnalyticsPipelineCondition
    DependsOn:
      - MediaInsightsWorkflowApi
      - MediaInsightsDataplaneApiStack
    Properties:
      TemplateURL:
        !Join [
          "",
          [
            "https://",
            !FindInMap [ "SourceCode", "General", "GlobalS3Bucket" ],
            ".s3.amazonaws.com/",
            !FindInMap ["SourceCode", "General", "TemplateKeyPrefix"],
            "/media-insights-dataplane-streaming-stack.template",
          ],
        ]
      Parameters:
        DynamoStreamArn:
          Fn::GetAtt:
            - DataplaneTable
            - StreamArn
        DynamoTableArn: !GetAtt DataplaneTable.Arn
        botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]

  # Workflow creation and execution API
  MediaInsightsWorkflowApi:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL:
        !Join [
          "",
          [
            "https://",
            !FindInMap [ "SourceCode", "General", "GlobalS3Bucket" ],
            ".s3.amazonaws.com/",
            !FindInMap ["SourceCode", "General", "TemplateKeyPrefix"],
            "/media-insights-workflowapi-stack.template",
          ],
        ]
      Parameters:
        botoConfig: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]
        ShortUUID: !GetAtt GetShortUUID.Data
        StageExecutionQueueUrl: !Ref StageExecutionQueue
        StageExecutionRole: !GetAtt StepFunctionRole.Arn
        OperationTableName: !Ref OperationTable
        StageTableName: !Ref StageTable
        WorkflowExecutionTableName: !Ref WorkflowExecutionTable
        WorkflowTableName: !Ref WorkflowTable
        HistoryTableName: !Ref HistoryTable
        SystemTableName: !Ref SystemTable
        SqsQueueArn: !GetAtt StageExecutionQueue.Arn
        MediaInsightsEnginePython38Layer: !Ref MediaInsightsEnginePython38Layer
        TracingConfigMode: !If [EnableTraceOnEntryPoints, "Active", "PassThrough"]
        CompleteStageLambdaArn:
          Fn::GetAtt:
            - CompleteStageLambda
            - Arn
        FilterOperationLambdaArn:
          Fn::GetAtt:
            - FilterOperationLambda
            - Arn
        WorkflowSchedulerLambdaArn:
          Fn::GetAtt:
            - WorkflowSchedulerLambda
            - Arn
        DataplaneEndpoint:
          Fn::GetAtt:
            - MediaInsightsDataplaneApiStack
            - Outputs.APIHandlerName
        DataplaneHandlerArn:
          Fn::GetAtt:
            - MediaInsightsDataplaneApiStack
            - Outputs.APIHandlerArn
        DataPlaneBucket: !Ref Dataplane
        OperatorFailedHandlerLambdaArn: !GetAtt OperatorFailedLambda.Arn
        DeploymentPackageBucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        DeploymentPackageKey:
          !Join [
            "/",
            [
            !FindInMap ["SourceCode", "General", "CodeKeyPrefix"],
            "workflowapi.zip",
            ],
          ]
        FrameworkVersion: !FindInMap ["SourceCode", "General", "FrameworkVersion"]

  OperatorLibrary:
    DependsOn:
      - MediaInsightsWorkflowApi
      - MediaInsightsDataplaneApiStack
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL:
        !Join [
          "",
          [
            "https://",
            !FindInMap [ "SourceCode", "General", "GlobalS3Bucket" ],
            ".s3.amazonaws.com/",
            !FindInMap ["SourceCode", "General", "TemplateKeyPrefix"],
            "/media-insights-operator-library.template",
          ],
        ]
      Parameters:
        WorkflowCustomResourceArn:
          Fn::GetAtt:
            - MediaInsightsWorkflowApi
            - Outputs.WorkflowCustomResourceArn
        DataPlaneEndpoint: !GetAtt MediaInsightsDataplaneApiStack.Outputs.APIHandlerName
        DataPlaneHandlerArn: !GetAtt MediaInsightsDataplaneApiStack.Outputs.APIHandlerArn
        DataPlaneBucket: !Ref Dataplane
        ExternalBucketArn: !Ref ExternalBucketArn
        MediaInsightsEnginePython38Layer: !Ref MediaInsightsEnginePython38Layer
        MediaInsightsEnginePython37Layer: !Ref MediaInsightsEnginePython37Layer
        MediaInsightsEnginePython36Layer: !Ref MediaInsightsEnginePython36Layer
        StartWaitOperationLambda: !GetAtt StartWaitOperationLambda.Arn
        CheckWaitOperationLambda: !GetAtt CheckWaitOperationLambda.Arn
        MediaConvertEndpoint: !GetAtt GetMediaConvertEndpoint.Data
        Boto3UserAgent: !Join ['', ['{"user_agent_extra": "AwsSolution/', !Ref "SolutionId", '/', !Ref "SolutionVersion", '"}']]

  TestResources:
    Condition: DeployTestResourcesCondition
    DependsOn:
      - MediaInsightsWorkflowApi
      - MediaInsightsDataplaneApiStack
      - OperatorLibrary
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL:
        !Join [
          "",
          [
            "https://",
            !FindInMap [ "SourceCode", "General", "GlobalS3Bucket" ],
            ".s3.amazonaws.com/",
            !FindInMap ["SourceCode", "General", "TemplateKeyPrefix"],
            "/media-insights-test-operations-stack.template",
          ],
        ]
      Parameters:
        WorkflowCustomResourceArn:
          Fn::GetAtt:
            - MediaInsightsWorkflowApi
            - Outputs.WorkflowCustomResourceArn
        DataplaneEndpoint:
          Fn::GetAtt:
            - MediaInsightsDataplaneApiStack
            - Outputs.APIHandlerName
        DataPlaneBucket: !Ref Dataplane
        MediaInsightsEnginePython38Layer: !Ref MediaInsightsEnginePython38Layer

  AnonymousDataCustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: "/"
      Policies:
        -
          PolicyName: !Sub "${AWS::StackName}-anonymous-data-logger"
          PolicyDocument:
            Statement:
              -
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Join ["", ["arn:aws:logs:", Ref: "AWS::Region", ":", Ref: "AWS::AccountId", ":log-group:/aws/lambda/*"]]
              -
                Effect: Allow
                Action:
                  - ssm:PutParameter
                Resource:
                  - !Join ["", ["arn:aws:ssm:", Ref: "AWS::Region", ":", Ref: "AWS::AccountId", ":parameter/*"]]

  AnonymousDataCustomResource:
    Type: AWS::Lambda::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: "This Lambda function does not need to access any resource provisioned within a VPC."
          - id: W92
            reason: "This function does not require performance optimization, so the default concurrency limits suffice."
    Properties:
      FunctionName: !Sub ${AWS::StackName}-anonymous-data
      Description: Used to send anonymous data
      Handler: anonymous-data-logger.handler
      Role: !GetAtt AnonymousDataCustomResourceRole.Arn
      Code:
        S3Bucket: !Join ["-", [!FindInMap ["SourceCode", "General", "RegionalS3Bucket"], Ref: "AWS::Region"]]
        S3Key: !Join ["/", [!FindInMap ["SourceCode", "General", "CodeKeyPrefix"], "anonymous-data-logger.zip"]]
      Runtime:  python3.8
      Timeout: 180

  # SendAnonymousData
  AnonymousDataUuid:
    Condition: EnableAnonymousData
    Type: "Custom::UUID"
    Properties:
      ServiceToken: !GetAtt AnonymousDataCustomResource.Arn
      Resource: UUID

  AnonymousMetric:
    Condition: EnableAnonymousData
    Type: "Custom::AnonymousMetric"
    Properties:
      ServiceToken: !GetAtt AnonymousDataCustomResource.Arn
      Resource: AnonymousMetric
      SolutionId: "SO0163"
      UUID: !GetAtt AnonymousDataUuid.UUID
      Version: !FindInMap ["SourceCode", "General", "FrameworkVersion"]

Outputs:
  OperatorLibraryStack:
    Description: Nested cloudformation stack that contains the MIE operator library
    Value: !GetAtt OperatorLibrary.Outputs.StackName
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", OperatorLibraryStack]]
  DataplaneBucket:
    Description: Bucket used to store transfomred media object from workflow execution
    Value: !Ref Dataplane
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", DataplaneBucket]]
  DataplaneApiEndpoint:
    Description: Endpoint for data persisitence API
    Value: !GetAtt MediaInsightsDataplaneApiStack.Outputs.EndpointURL
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", DataplaneApiEndpoint]]
  DataPlaneHandlerArn:
    Description: API Handler Lambda ARN for dataplane.
    Value: !GetAtt MediaInsightsDataplaneApiStack.Outputs.APIHandlerArn
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", DataPlaneHandlerArn]]
  DataplaneApiRestID:
    Description: REST API ID for dataplane API
    Value: !GetAtt MediaInsightsDataplaneApiStack.Outputs.RestAPIId
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", DataplaneApiId]]
  WorkflowCustomResourceArn:
    Description: Custom resource for creating operations, stages and workflows using CloudFormation
    Value: !GetAtt MediaInsightsWorkflowApi.Outputs.WorkflowCustomResourceArn
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", WorkflowCustomResourceArn]]
  WorkflowApiEndpoint:
    Description: Endpoint for workflow Creation, Execution and Monitoring API
    Value: !GetAtt MediaInsightsWorkflowApi.Outputs.EndpointURL
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", WorkflowApiEndpoint]]
  WorkflowApiRestID:
    Description: REST API ID for workflow API
    Value: !GetAtt MediaInsightsWorkflowApi.Outputs.RestAPIId
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", WorkflowApiId]]
  MediaInsightsEnginePython38Layer:
    Description: Lambda layer for Python libraries
    Value: !Ref MediaInsightsEnginePython38Layer
    Export:
      Name:
        !Join [":", [!Ref "AWS::StackName", MediaInsightsEnginePython38Layer]]
  AnalyticsStreamArn:
    Description: Arn of the dataplane pipeline
    Value: !GetAtt Analytics.Outputs.analyticsStreamArn
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", AnalyticsStreamArn]]
  TestStack:
    Condition: DeployTestResourcesCondition
    Value: !Ref TestResources
  Version:
    Description: Media Insights Engine Version
    Value: !FindInMap ["SourceCode", "General", "FrameworkVersion"]
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", Version]]
